---
output: 
  pagedown::html_paged:
    css: www/styles_MIDN_pages.css
    toc: false
    numbered_sections: false
    number_sections: false
    #includes:
      #in_header: "header_MIDN.html"
      #after_body: "footer.html"
params:
  park: 'APCO' 

---
```{r setup, include = FALSE, results = 'hide'}
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
options(knitr.kable.NA = '')

library(pagedown)
library(tidyverse)
library(forestMIDN)
library(htmltools)
library(knitr)
library(kableExtra)
library(cowplot)
#devtools::install_github(repo="haozhu233/kableExtra", ref="a6af5c0") # for collapse_rows()
library(kableExtra)
#devtools::install_github("katemmiller/forestTrends")
library(forestTrends)
library(sf)
library(vegan)
```

```{r}
# assign params to global env. for source files to find. Makes iterating easier.
midn_names <- read.csv("MIDN_MetaData.csv")
midn_params <- read.csv("MIDN_params.csv")
park <<- params$park
park <<- park
from <<- as.numeric(midn_params$from[midn_params$park == park])
from_4yr <<- as.numeric(midn_params$from_4yr[midn_params$park == park])
to <<- as.numeric(midn_params$to[midn_params$park == park])
cycle_latest <<- as.numeric(midn_params$cycle_latest[midn_params$park == park])
from_prev <<- as.numeric(midn_params$from_prev[midn_params$park == park])
to_prev <<- as.numeric(midn_params$to_prev[midn_params$park == park])
QAQC <<- FALSE
locType <<- 'VS'

# park = 'FRSP' #'RICH' #'PETE'
# from = 2007
# from_4yr = 2021
# to = 2023
# cycle_latest = 5
# from_prev = 2016
# to_prev = 2019

park_long <- midn_names$LongName[midn_names$ParkCode == park]
park_title <- midn_names$LongName_title[midn_names$ParkCode == park]
```
```{r include = F, cache = F}
source('source_script_MIDN.R') # Runs all the other scripts behind the scenes. If you run into problems,
# go directly to this script and try running with the parameters set in this report. 
```
```{r include = F, cache = F}
source('./scripts/forest_summary_code_MIDN.R')
```
```{r include = F, cache = F}
source('./scripts/regen_debt_metrics_MIDN.R')
```
```{r include = F, cache = F}
source('./scripts/tree_regen_stem_changes_by_species_loess_MIDN.R')
```

```{r results = 'asis', include = F}
html_header <- HTML('
<div class="banner">
  <div class="header">
    <div id="col-left-header">
        <h5> Mid-Atlantic Network </h5>
        <h5> Inventory & Monitoring Division </h5>
        <br>
        <h5> Forest Monitoring Data Summary </h5></div>
    <div id="col-right-header">
        <img src="www/ah_small_flat_4c_blackbkgr_k100.svg" alt="arrowhead"></div>
    <div id="col-middle-header">
        <h5> National Park Service </h5>
        <h5> U.S. Department of the Interior </h5>
        <br>
        <h5>', park_title, '</h5><br></div></div></div><br>')

save_html(html_header, "html_header.html")
```


```{r results = 'asis'}
includeHTML("html_header.html")
```

|       A. 
```{r out.width = "94%"}
include_graphics(paste0(new_path, "figures/Figure_1A_", park, "_regen_by_size_class_by_cycle.svg"))
```


|       B. 
```{r out.width = "94%"}
include_graphics(paste0(new_path, "figures/Figure_1B_", park, "_tree_dbh_dist_by_cycle.svg"))
```


```{r results = 'asis'}
cat(paste0("<p><b>Figure 1.</b> Stem density distributions by cycle in ", park_long, " (", park, ").",
    paste(cycle_labs, collapse = "; "), ". ", 
    ifelse(length(cycle_labs) == 5, "Note that cycle 5 is only partially complete. ", ""),
    "Figure A shows regeneration densities by size class. Figure B shows tree density by diameter at breast height (DBH) increments. Error bars are 95% bootstrapped confidence intervals. An asterisk denotes a linear DBH distribution that is indicative of long-term recruitment failure.</p>", sep = ""))
```

### {.page-break-before}
```{r results = 'asis'}
includeHTML("html_header.html")
```
<br>
<br>
```{r out.width = "50%"}
include_graphics(paste0(new_path, "figures/Figure_2_Regen_Debt_table.svg"))
```


```{r results = 'asis'}
cat("<p><b>Figure 2.</b> Regeneration Debt metrics and status for the most recent 4-year census (",
    from_4yr, " \U2013 ", to, ") in", park_long, ". Flat Tree Diam. Dist. stands for Flat
Tree Diameter Distribution. If TRUE, the density of small trees is lower than expected due to
chronic regeneration failure. See <a href ='https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/eap.2837'>Miller et al. 2023</a> for more details on metric calculations, thresholds, and assessment of status.</p>", sep = "")
```


```{r out.width = "80%"}
include_graphics(paste0(new_path, "figures/", "Figure_3_", park, "_DBI_by_cycle.svg"))
```


```{r results = 'asis'}
cat(paste0("<p><b>Figure 3.</b> Deer browse impacts by cycle in ", park_long, " (", park, "). ",
    paste(cycle_labs, collapse = "; "), ". ", 
    ifelse(length(cycle_labs) == 5, "Note that cycle 5 is only partially complete. ", ""), 
    sep = ""))

```


### {.page-break-before}
```{r results = 'asis'}
includeHTML("html_header.html")
```


|       A. 
```{r out.width = "85%"}
include_graphics(paste0(new_path, "figures/Figure_4A_", park, "_net_seedlings_by_species_cycle.svg"))
```


|       B. 
```{r out.width = "85%"}
include_graphics(paste0(new_path, "figures/Figure_4B_", park, "_net_saplings_by_species_cycle.svg"))
```


```{r results = 'asis'}
cat("<p><b>Figure 4.</b> Loess smoothed changes in stem density for seedlings (A) and saplings (B) by
species group and sample year in ", park_long, ". Specified loess span
approximated a linear trend between consecutive sample events per panel.</p>", sep = "")
```

### {.page-break-before}
```{r results = 'asis'}
includeHTML("html_header.html")
```

|       A. 
```{r out.width = "85%"}
include_graphics(paste0(new_path, "figures/Figure_5A_", park, "_smoothed_tree_stems_by_species_cycle.svg"))
```


|       B. 
```{r out.width = "85%"}
include_graphics(paste0(new_path, "figures/Figure_5B_", park, "_smoothed_BA_by_species_cycle.svg"))
```


```{r results = 'asis'}
cat("<p><b>Figure 5.</b> Loess smoothed changes in tree stem density (A) and basal area (B) by
species group and sample year in ", park_long, ". Specified loess span
approximated a linear trend between consecutive sample events per panel.</p>", sep = "")
```

### {.page-break-before}
```{r results = 'asis'}
includeHTML("html_header.html")
```

```{r out.width = "85%"}
include_graphics(paste0(new_path, "figures/Figure_6_", park, "_smoothed_invasive_cover_by_guild_cycle.svg"))
```


```{r results = 'asis'}
cat("<p><b>Figure 6.</b> Loess smoothed changes in invasive plant percent cover by guild and sample year in ", 
    park_long, ". Specified loess span approximated a linear trend between consecutive sample events per panel.</p>", 
    sep = "")
```

### {.page-break-before}
```{r results = 'asis'}
includeHTML("html_header.html")
```

```{r include = F}
reg_cycle_tab <- reg_cycle_wide |> arrange(Plot) |> select(-Plot_Name)
tab1_cols <- names(reg_cycle_tab)
tab1_row2 <- gsub("seed_den_|sap_den_|stock_", "Cycle ", tab1_cols)
border_cols <- c(2 + cycle_latest, 2 + cycle_latest*2, 2 + cycle_latest*3)

reg_pass <- "#BFDFC7"

# Have to use %>% pipe to use the '.' in the reduce.
tab1 <- 
  kable(reg_cycle_tab, col.names = tab1_row2, digits = 2, align = 'c', format = 'html', 
        table.attr = "style='width:85%;'") %>%
  add_header_above(c(" " = 1, " " = 1, "Seedlings per sq.m" = cycle_latest, 
                     "Saplings per sq.m" = cycle_latest, 
                     "Stocking Index" = cycle_latest)) %>%
  kable_styling(fixed_thead = FALSE, bootstrap_options = 'condensed',
                full_width = FALSE, position = 'left', font_size = 10) %>%
  column_spec(c(1, 2), border_left = T, border_right = T) %>%
  column_spec(border_cols, border_right = T) %>%
  purrr::reduce(3:border_cols[1], function(x, y){
    col <- reg_cycle_tab[, y]
    column_spec(x, y, background = ifelse(col >= 0.25, reg_pass, "#FFFFFF"))}, .init = .) %>%
  purrr::reduce((border_cols[1] + 1): border_cols[2], function(x, y){
    col <- reg_cycle_tab[, y]
    column_spec(x, y, background = ifelse(col >= 0.14, reg_pass, "#FFFFFF"))}, .init = .) %>%
  purrr::reduce((border_cols[2] + 1): border_cols[3], function(x, y){
    col <- reg_cycle_tab[, y]
    column_spec(x, y, background = ifelse(col >= 100, reg_pass, "#FFFFFF"))}, .init = .) %>%
  row_spec(1, extra_css = "border-top: 1px solid #000000;") %>%
  row_spec(nrow(reg_cycle_tab), extra_css = "border-top: 1px solid #000000;") %>%
  save_kable(file = "table1.html", self_contained = T) # save as html b/c pagedown was having issues

```

```{r results = 'asis'}
cat("Table 1. Average plot-level seedling and sapling stem densities, converted to stems per sq.m, and stocking index by cycle. Only native, canopy-forming species are included. Note that Fraxinus spp. (ash species) are no longer considered canopy-forming species. ", paste0(cycle_labs, collapse = "; "), ". Plots are sampled in 4-year rotataions, with a quarter of the plots sampled each year (i.e. a panel). The stocking index quantifies whether current regeneration densities are sufficient to restock a forest canopy. The index is a weighted sum of seedling and sapling densities where larger seedling size classes get higher weights. Cells highlighted in green are plots that meet the minimum management target of 0.25 seedlings/m2 and 0.14 saplings/m2 or have a stocking index >100.", ifelse(length(cycle_labs) == 5, "Note that cycle 5 is only partially complete. ", ""), sep = "")
```

```{r echo = F}
htmltools::includeHTML("table1.html")
```



### {.page-break-before}
```{r results = 'asis'}
includeHTML("html_header.html")
```